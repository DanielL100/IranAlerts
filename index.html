<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מנבא התרעות 2026 - גרסת המודלים הנפרדים</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root { 
            --צפון: #2563eb; --מרכז: #dc2626; --דרום: #059669; --יוש: #7c3aed;
            --bg: #f8fafc; 
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { padding: 12px 25px; border: 2px solid #e2e8f0; background: white; cursor: pointer; border-radius: 12px; font-weight: bold; white-space: nowrap; }
        .tab-btn.active { color: white; border-color: transparent; }
        .tab-btn[data-r="צפון"].active { background: var(--צפון); }
        .tab-btn[data-r="מרכז"].active { background: var(--מרכז); }
        .tab-btn[data-r="דרום"].active { background: var(--דרום); }
        .tab-btn[data-r="יוש"].active { background: var(--יוש); }

        .chart-container { position: relative; height: 550px; width: 100%; }
        
        .prediction-box { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #f1f5f9; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 4px solid #cbd5e1; }
        .stat-val { font-size: 1.8em; font-weight: 800; display: block; }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        .row-צפון { border-right: 4px solid var(--צפון); }
        .row-מרכז { border-right: 4px solid var(--מרכז); }
        .row-דרום { border-right: 4px solid var(--דרום); }
        .row-יוש { border-right: 4px solid var(--יוש); }
    </style>
</head>
<body>

<div class="container">
    <div class="card" id="upload-panel">
        <h2>מערכת ניבוי רב-גזרתית v5</h2>
        <p>טען את קובץ ה-history.json לניתוח מגמות נפרדות לכל חזית.</p>
        <input type="file" id="jsonFile" accept=".json">
    </div>

    <div id="dashboard" style="display:none">
        <div class="tabs" id="tabsList"></div>
        
        <div class="prediction-box">
            <div class="stat-card">
                <span style="font-size:0.9em">ניבוי למטח הבא (גזרה נבחרת)</span>
                <span id="nextTime" class="stat-val">--:--</span>
            </div>
            <div class="stat-card">
                <span style="font-size:0.9em">זמן שנותר</span>
                <span id="timeLeft" class="stat-val">--</span>
            </div>
            <div class="stat-card">
                <span style="font-size:0.9em">עצימות חזויה</span>
                <span id="predIntensity" class="stat-val">--</span>
            </div>
        </div>

        <div class="card">
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h4>יומן אירועים משולב (החל מ-28/02/2026)</h4>
            <table id="historyTable">
                <thead>
                    <tr><th>שעה</th><th>גזרה</th><th>עצימות</th><th>מיקומים</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
const CUTOFF_TS = Math.floor(new Date('2026-02-28T00:00:00').getTime() / 1000);
const REGION_COLORS = { 'צפון': '#2563eb', 'מרכז': '#dc2626', 'דרום': '#059669', 'יוש': '#7c3aed' };
const KEYWORDS = {
    'צפון': ['גליל', 'גולן', 'חיפה', 'קריות', 'נהריה', 'עכו', 'צפת', 'קצרין', 'שלומי'],
    'מרכז': ['תל אביב', 'גוש דן', 'שרון', 'שפלה', 'ראשון', 'נתניה', 'פתח תקווה', 'חולון'],
    'דרום': ['עוטף', 'אשקלון', 'אשדוד', 'באר שבע', 'נתיבות', 'שדרות', 'אילת'],
    'יוש': ['יהודה', 'שומרון', 'בנימין', 'אריאל', 'מעלה אדומים']
};

let allSalvos = {};
let activeRegion = '';
let chart = null;

document.getElementById('jsonFile').addEventListener('change', e => {
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const data = JSON.parse(ev.target.result);
            process(data);
        } catch(err) { alert("שגיאה בקריאת הקובץ"); }
    };
    reader.readAsText(e.target.files[0]);
});

function process(data) {
    const bins = { 'צפון': [], 'מרכז': [], 'דרום': [], 'יוש': [] };
    const filtered = data.filter(d => d[3] >= CUTOFF_TS && d[1] === 0);

    filtered.forEach(item => {
        const txt = item[2].join(' ');
        for (let r in KEYWORDS) {
            if (KEYWORDS[r].some(k => txt.includes(k))) {
                bins[r].push({ t: item[3], locs: item[2] });
                break;
            }
        }
    });

    for (let r in bins) {
        if (bins[r].length > 0) allSalvos[r] = group(bins[r]);
    }

    renderTabs();
    updateView(Object.keys(allSalvos)[0] || 'צפון');
    document.getElementById('dashboard').style.display = 'block';
    document.getElementById('upload-panel').style.display = 'none';
}

function group(alerts) {
    alerts.sort((a,b) => a.t - b.t);
    const salvos = [];
    if(alerts.length === 0) return [];
    let cur = { s: alerts[0].t, e: alerts[0].t, count: alerts[0].locs.length, list: new Set(alerts[0].locs) };
    for(let i=1; i<alerts.length; i++) {
        if(alerts[i].t - cur.e <= 300) {
            cur.e = alerts[i].t;
            cur.count += alerts[i].locs.length;
            alerts[i].locs.forEach(l => cur.list.add(l));
        } else {
            salvos.push(cur);
            cur = { s: alerts[i].t, e: alerts[i].t, count: alerts[i].locs.length, list: new Set(alerts[i].locs) };
        }
    }
    salvos.push(cur);
    return salvos;
}

function getPrediction(region) {
    const salvos = allSalvos[region];
    if(!salvos || salvos.length < 2) return null;
    
    const now = Math.floor(Date.now() / 1000);
    const last = salvos[salvos.length - 1];
    
    let intervals = [];
    for(let i=1; i<salvos.length; i++) intervals.push(salvos[i].s - salvos[i-1].e);
    
    // חישוב מרווח מותאם אישית לגזרה
    const avg = intervals.reduce((a,b)=>a+b,0) / intervals.length;
    let predTime = last.e + avg;

    // תיקון "זמן עבר" + למידה מהשונות
    if (predTime <= now) {
        const maxInt = Math.max(...intervals);
        predTime = Math.max(now + 300, last.e + maxInt);
    }

    // ניבוי עצימות
    const avgIntensity = salvos.reduce((a,b)=>a+b.count,0) / salvos.length;

    return {
        time: new Date(predTime * 1000),
        minutes: Math.round((predTime - now) / 60),
        intensity: Math.round(avgIntensity)
    };
}

function renderTabs() {
    const list = document.getElementById('tabsList');
    list.innerHTML = '';
    Object.keys(allSalvos).forEach(r => {
        const b = document.createElement('button');
        b.className = 'tab-btn';
        b.innerText = r;
        b.setAttribute('data-r', r);
        b.onclick = () => updateView(r);
        list.appendChild(b);
    });
}

function updateView(region) {
    activeRegion = region;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.getAttribute('data-r') === region));
    
    const pred = getPrediction(region);
    if(pred) {
        document.getElementById('nextTime').innerText = pred.time.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('timeLeft').innerText = pred.minutes + " דקות";
        document.getElementById('predIntensity').innerText = pred.intensity + " ישובים";
    }

    renderChart();
    renderTable();
}

function renderChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    if (chart) chart.destroy();

    const datasets = Object.keys(allSalvos).map(r => {
        const isSelected = (r === activeRegion);
        return {
            label: r,
            data: allSalvos[r].map(s => ({ x: s.s * 1000, y: s.count })),
            borderColor: REGION_COLORS[r],
            backgroundColor: REGION_COLORS[r] + (isSelected ? '33' : '00'),
            borderWidth: isSelected ? 4 : 1.5,
            pointRadius: isSelected ? 6 : 2,
            fill: isSelected,
            tension: 0.2
        };
    });

    chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { type: 'time', time: { unit: 'hour' } },
                y: { beginAtZero: true }
            }
        }
    });
}

function renderTable() {
    const tbody = document.querySelector('#historyTable tbody');
    let combined = [];
    Object.keys(allSalvos).forEach(r => {
        allSalvos[r].forEach(s => combined.push({ ...s, region: r }));
    });
    combined.sort((a,b) => b.s - a.s);

    tbody.innerHTML = combined.map(s => `
        <tr class="row-${s.region}">
            <td>${new Date(s.s*1000).toLocaleTimeString()}</td>
            <td><strong>${s.region}</strong></td>
            <td>${s.count}</td>
            <td>${Array.from(s.list).slice(0,3).join(', ')}...</td>
        </tr>
    `).join('');
}
</script>
</body>
</html>
