<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×× ×‘× ××–×¢×§×•×ª | ×¦×‘×¢ ××“×•× ×”×™×¡×˜×•×¨×™</title>
<link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
/* × ×©××¨ ×”×¢×™×¦×•×‘ ×”××§×•×¨×™ ×©×œ×š (CSS) */
:root {
  --red: #ff3344; --amber: #ff9900; --green: #00dd77; --blue: #2299ff;
  --bg: #07070e; --panel: #0f0f1e; --border: #1c1c38; --text: #eeeeff; --muted: #445577;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: var(--bg); color: var(--text); font-family: 'Rubik', sans-serif; min-height: 100vh; }
.wrap { max-width: 1100px; margin: 0 auto; padding: 24px 20px; position: relative; z-index: 2; }
header { text-align: center; padding: 36px 0; border-bottom: 1px solid var(--border); margin-bottom: 32px; }
h1 { font-size: clamp(32px, 5.5vw, 58px); background: linear-gradient(150deg, #fff, var(--blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
.status-bar { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-bottom: 24px; display: flex; justify-content: space-between; }
.tabs { display: grid; grid-template-columns: repeat(5,1fr); gap: 10px; margin-bottom: 28px; }
.tab { background: var(--panel); border: 1.5px solid var(--border); border-radius: 10px; padding: 15px; cursor: pointer; color: var(--muted); text-align: center; }
.tab.on { border-color: var(--blue); color: var(--blue); background: rgba(34,153,255,.1); }
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
.card { background: var(--panel); border: 1.5px solid var(--border); border-radius: 12px; padding: 26px; }
.pred-time { font-family: 'JetBrains Mono'; font-size: 48px; color: var(--amber); }
.pc-v { font-family: 'JetBrains Mono'; font-size: 24px; }
.tchart { display: flex; align-items: flex-end; gap: 4px; height: 120px; }
.tb { width: 100%; border-radius: 2px 2px 0 0; }
#loadOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.spinner { width: 50px; height: 50px; border: 3px solid #1c1c38; border-top-color: var(--blue); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loadOverlay">
  <div class="spinner"></div>
  <p style="margin-top:20px">×©×•××‘ × ×ª×•× ×™× ×-Tzeva Adom...</p>
</div>

<div class="wrap">
  <header>
    <h1>×× ×‘× ××–×¢×§×•×ª ×¡×˜×˜×™×¡×˜×™</h1>
    <p style="color:var(--muted)">× ×™×ª×•×— ××‘×•×¡×¡ ×”×™×¡×˜×•×¨×™×™×ª ×©×™×’×•×¨×™× ×××™×¨××Ÿ 2025-2026</p>
  </header>

  <div class="status-bar">
    <div>×¡×”"×› ××™×¨×•×¢×™× ×‘××¢×¨×›×ª: <span id="totalLoaded" style="color:var(--blue)">0</span></div>
    <div id="statusBadge">××—×•×‘×¨ ×œ×××’×¨</div>
  </div>

  <div class="tabs">
    <button class="tab on" onclick="selTab('all')" id="t-all">ğŸ‡®ğŸ‡± ×›×œ ×”××¨×¥</button>
    <button class="tab" onclick="selTab('n')" id="t-n">ğŸ”ï¸ ×¦×¤×•×Ÿ (×—×™×¤×”)</button>
    <button class="tab" onclick="selTab('c')" id="t-c">ğŸ™ï¸ ××¨×›×– (×ª"×)</button>
    <button class="tab" onclick="selTab('s')" id="t-s">ğŸœï¸ ×“×¨×•× (×‘"×©)</button>
    <button class="tab" onclick="selTab('w')" id="t-w">ğŸ—ºï¸ ×™×•"×© (×™-×)</button>
  </div>

  <div class="grid2">
    <div class="card">
      <p style="color:var(--muted); font-size:12px">â± ×–××Ÿ ××©×•×¢×¨ ×œ××™×¨×•×¢ ×”×‘×</p>
      <div class="pred-time" id="predTime">--</div>
      <p id="predLbl" style="font-size:14px; color:var(--muted)">××—×©×‘ ×”×¡×ª×‘×¨×•×ª...</p>
    </div>
    <div class="card">
      <p style="color:var(--muted); font-size:12px">ğŸ“Š ×”×¡×ª×‘×¨×•×ª ×‘-24 ×©×¢×•×ª ×”×§×¨×•×‘×•×ª</p>
      <div class="pc-v" id="p24" style="font-size:48px; color:var(--red)">0%</div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <p style="margin-bottom:15px; color:var(--muted)">ğŸ“… ×¦×¤×™×¤×•×ª ××™×¨×•×¢×™× (×”×™×¡×˜×•×¨×™×”)</p>
    <div class="tchart" id="tchart"></div>
  </div>
</div>

<script>
// ×”×’×“×¨×ª ××–×”×™ ×¢×¨×™× ××”××ª×¨ ×©×¦×™×™× ×ª
const REGIONS = {
  all: { name: '×›×œ ×”××¨×¥', ids: [] },
  n: { name: '×¦×¤×•×Ÿ', city: '×—×™×¤×”', ids: [120, 121, 122, 123, 124] },
  c: { name: '××¨×›×–', city: '×ª×œ ××‘×™×‘', ids: [742, 687, 467, 804] },
  s: { name: '×“×¨×•×', city: '×‘××¨ ×©×‘×¢', ids: [305, 306, 307, 308] },
  w: { name: '×™×•"×©', city: '×™×¨×•×©×œ×™×', ids: [580, 581, 582, 400] }
};

let DATA = { all: [], n: [], c: [], s: [], w: [] };
let selectedTab = 'all';

async function loadData() {
    try {
        // ××©×™×›×ª × ×ª×•× ×™× ×“×¨×š Proxy ×œ×¢×§×™×¤×ª CORS
        const targetUrl = 'https://www.tzevaadom.co.il/api/history?limit=1000';
        const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`);
        const wrapper = await response.json();
        const alerts = JSON.parse(wrapper.contents);

        DATA = { all: [], n: [], c: [], s: [], w: [] };

        alerts.forEach(item => {
            const cityId = parseInt(item.city_id);
            const alertItem = {
                time: item.time, // Unix Timestamp
                date: new Date(item.time * 1000),
                city: item.city_name
            };

            DATA.all.push(alertItem);
            if (REGIONS.n.ids.includes(cityId)) DATA.n.push(alertItem);
            if (REGIONS.c.ids.includes(cityId)) DATA.c.push(alertItem);
            if (REGIONS.s.ids.includes(cityId)) DATA.s.push(alertItem);
            if (REGIONS.w.ids.includes(cityId)) DATA.w.push(alertItem);
        });

        document.getElementById('totalLoaded').textContent = DATA.all.length;
        updateUI();
        document.getElementById('loadOverlay').style.display = 'none';

    } catch (e) {
        console.error("×˜×¢×™× ×” × ×›×©×œ×”", e);
        alert("×©×’×™××” ×‘××©×™×›×ª × ×ª×•× ×™×. × ×¡×” ×œ×¨×¢× ×Ÿ.");
    }
}

function updateUI() {
    const list = DATA[selectedTab];
    if (list.length < 2) {
        document.getElementById('predTime').textContent = "××™×Ÿ ××™×“×¢";
        return;
    }

    // ×—×™×©×•×‘ ×××•×¦×¢ ×©×¢×•×ª ×‘×™×Ÿ ××–×¢×§×•×ª
    const sorted = [...list].sort((a, b) => a.time - b.time);
    let diffs = [];
    for (let i = 1; i < sorted.length; i++) {
        diffs.push((sorted[i].time - sorted[i-1].time) / 3600);
    }
    const avgHours = diffs.reduce((a, b) => a + b, 0) / diffs.length;
    
    // ×—×™×–×•×™ ×¤×•××¡×•×Ÿ (×œ-24 ×©×¢×•×ª)
    const lambda = 1 / avgHours;
    const prob24 = (1 - Math.exp(-lambda * 24)) * 100;

    // ×¢×“×›×•×Ÿ ×ª×¦×•×’×”
    document.getElementById('predTime').textContent = avgHours > 24 ? (avgHours/24).toFixed(1) + " ×™××™×" : avgHours.toFixed(1) + " ×©×¢×•×ª";
    document.getElementById('p24').textContent = prob24.toFixed(1) + "%";
    document.getElementById('p24').style.color = prob24 > 50 ? 'var(--red)' : 'var(--amber)';
    
    drawChart(sorted);
}

function drawChart(sorted) {
    const container = document.getElementById('tchart');
    container.innerHTML = '';
    const max = 10; // ×§× ×” ××™×“×”
    
    // ×œ×•×§×— ××ª 50 ×”××™×¨×•×¢×™× ×”××—×¨×•× ×™× ×œ×”×¦×’×”
    sorted.slice(-50).forEach(item => {
        const bar = document.createElement('div');
        bar.className = 'tb';
        bar.style.height = '40px';
        bar.style.background = 'var(--blue)';
        bar.style.opacity = '0.6';
        bar.title = item.date.toLocaleString();
        container.appendChild(bar);
    });
}

function selTab(r) {
    selectedTab = r;
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('on'));
    document.getElementById('t-' + r).classList.add('on');
    updateUI();
}

// ×”×¨×¦×” ×¨××©×•× ×™×ª
loadData();
</script>
</body>
</html>